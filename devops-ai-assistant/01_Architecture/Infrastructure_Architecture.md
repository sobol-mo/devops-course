# Архітектура інфраструктури

**Версія**: 3.0 (Навчальне видання — курс «Основи DevOps»)
**Дата**: 2026-02-27
**Аудиторія**: Студенти курсу «Основи DevOps»

---

## Огляд

У цьому курсі ми симулюємо реальне production-середовище локально, використовуючи Virtual Machine.
Це дає змогу відпрацювати всі DevOps-інструменти (Ansible, SSH, systemd, Docker)
без необхідності орендувати хмарний VPS та витрачати кошти.

> **Ключовий принцип:** Локальна VM, налаштована ідентично до реального VPS — це повноцінне
> та професійне середовище розробки. Цей підхід називається **Dev Environment**.

---

## Схема архітектури

```
┌─────────────────────────────────┐        ┌────────────────────────────────────────────┐
│  YOUR COMPUTER (Host Machine)   │        │  VIRTUAL MACHINE (simulates a VPS/Server)  │
│                                 │        │                                            │
│  ┌───────────────────────────┐  │        │  ┌──────────────────────────────────────┐  │
│  │  Browser / Telegram       │  │        │  │  OS: Ubuntu Server 22.04             │  │
│  │  (accessing agent UI)     │  │        │  │                                      │  │
│  └───────────┬───────────────┘  │        │  │  Firewall (ufw)                      │  │
│              │                  │        │  │  └─ ALLOW: port 22 (SSH) only        │  │
│  ┌───────────▼───────────────┐  │        │  │  └─ DENY: all other ports            │  │
│  │  SSH Tunnel               │  │        │  │                                      │  │
│  │  localhost:18789          │◄─┼──SSH───┼─►│  ┌────────────────────────────────┐  │  │
│  │  → VM:localhost:18789     │  │  :22   │  │  │  System User: openclaw         │  │  │
│  └───────────────────────────┘  │        │  │  │  (no sudo, isolated)           │  │  │
│                                 │        │  │  │                                │  │  │
│  ┌───────────────────────────┐  │        │  │  │  ┌──────────────────────────┐  │  │  │
│  │  Terminal                 │  │        │  │  │  │  OpenClaw Agent          │  │  │  │
│  │  (SSH management)         │◄─┼──SSH───┼─►│  │  │  (Node.js process)       │  │  │  │
│  └───────────────────────────┘  │  :22   │  │  │  │  listens: localhost:18789│  │  │  │
│                                 │        │  │  │  └──────────────────────────┘  │  │  │
└─────────────────────────────────┘        │  │  │                                │  │  │
                                           │  │  │  Managed by: systemd service   │  │  │
                                           │  │  └────────────────────────────────┘  │  │
                                           │  │                                      │  │
                                           │  │  ┌────────────────────────────────┐  │  │
                                           │  │  │  PostgreSQL (Docker container) │  │  │
                                           │  │  │  port: 5432 (localhost only)  │  │  │
                                           │  │  └────────────────────────────────┘  │  │
                                           │  └──────────────────────────────────────┘  │
                                           └────────────────────────────────────────────┘
```

---

## Середовища (Environments)

| Середовище      | Інфраструктура        | Призначення                               |
| --------------- | --------------------- | ----------------------------------------- |
| **Development** | Local VM (VirtualBox) | Навчання, експерименти, безпечні помилки  |
| **Production**  | Real VPS (cloud)      | Реальне розгортання *(майбутній scope)*   |

> У цьому курсі ми працюємо **виключно з Development-середовищем** (локальна VM).
> Архітектура навмисно ідентична до production — навички переносяться напряму.

---

## Специфікація Virtual Machine

| Параметр    | Значення                           |
| ----------- | ---------------------------------- |
| Гіпервізор  | VirtualBox або QEMU/KVM            |
| ОС          | Ubuntu Server 22.04 LTS            |
| CPU         | 2 ядра                             |
| RAM         | 2 GB                               |
| Диск        | 20 GB                              |
| Мережа      | NAT + Port Forwarding (або Bridged)|

### Port Forwarding (NAT-режим)

| Порт Host | Порт VM | Призначення             |
| --------- | ------- | ----------------------- |
| `2222`    | `22`    | SSH-доступ до VM        |
| `18789`   | `18789` | UI агента (через тунель)|

---

## Модель безпеки

Агент розгорнуто відповідно до принципу **Principle of Least Privilege** (мінімум необхідних прав):

### Шар 1 — Firewall

- Ззовні відкритий лише порт `22` (SSH).
- Всі інші порти заблоковані через `ufw` (Uncomplicated Firewall).

### Шар 2 — Окремий системний користувач

- Агент запускається від імені користувача `openclaw` — **без прав `sudo`**.
- Якщо процес агента буде скомпрометовано — зловмисник не отримає доступу до решти системи.

### Шар 3 — Прив'язка тільки до localhost

- Агент слухає на `localhost:18789` — **не** на `0.0.0.0`.
- UI фізично недоступний ззовні сервера.

### Шар 4 — SSH-тунель для доступу до UI

```bash
# Підключитися до UI агента зі свого комп'ютера:
ssh -L 18789:localhost:18789 -p 2222 openclaw@localhost

# Потім відкрити у браузері:
# http://localhost:18789
```

---

## Infrastructure as Code

Вся конфігурація сервера автоматизована та зберігається в цьому репозиторії:

```
devops-ai-assistant/
└── 10_Implementation/
    ├── ansible/
    │   ├── ansible.cfg                  ← Конфігурація Ansible
    │   ├── inventory.ini                ← Цільові хости (адреса VM)
    │   ├── playbook-openclaw-setup.yml  ← Головний playbook автоматизації
    │   └── templates/
    │       └── openclaw.service.j2      ← Шаблон systemd unit
    └── terraform/
        ├── Vagrantfile                  ← Опціонально: provisioning VM через Vagrant
        └── README.md
```

**Що автоматизує Ansible playbook:**

1. Створює системного користувача `openclaw` (без sudo)
2. Встановлює Node.js runtime
3. Створює директорію `/opt/openclaw` з правильними дозволами
4. Розгортає файли агента
5. Встановлює та активує systemd unit `openclaw.service`
6. Налаштовує правила firewall

> **Результат:** Свіжа VM перетворюється на повністю робочий сервер
> однією командою: `ansible-playbook playbook-openclaw-setup.yml`

---

## Стек застосунку

| Компонент       | Технологія              | Призначення                            |
| --------------- | ----------------------- | -------------------------------------- |
| **AI Agent**    | OpenClaw (Node.js)      | Розмовний ШІ, виконання інструментів   |
| **Інтерфейс**   | Telegram Bot            | Комунікація з користувачем             |
| **База даних**  | PostgreSQL (Docker)     | Зберігання даних                       |
| **Process Mgr** | systemd                 | Автозапуск, автоперезапуск, логи       |
| **Config Mgmt** | Ansible                 | Автоматизоване налаштування сервера    |

---

## Схема взаємодії

```
Користувач (Telegram)
        │
        ▼
Telegram Bot API  ──────────────────────────────────────────────►  OpenClaw Agent
(хмара, polling)                                                  (запущений на VM)
                                                                        │
                                                       ┌────────────────┤
                                                       │                │
                                                       ▼                ▼
                                                  PostgreSQL       LLM API
                                                (постійні дані)  (Claude/OpenAI)
```

---

## Які DevOps-концепції демонструє ця архітектура

| Модуль курсу | Концепція              | Де видно в архітектурі                        |
| ------------ | ---------------------- | --------------------------------------------- |
| Модуль 1     | Virtualization         | VirtualBox VM як Dev Environment              |
| Модуль 2     | Linux / Users          | Користувач `openclaw`, права, директорії      |
| Модуль 3     | Networking             | Порти, localhost vs 0.0.0.0, firewall         |
| Модуль 4     | SSH                    | SSH-ключі, SSH-тунель                         |
| Модуль 5     | Git                    | Цей репозиторій як Single Source of Truth     |
| Модуль 6     | IaC (Ansible)          | `playbook-openclaw-setup.yml`                 |
| Модуль 7     | systemd                | Unit-файл `openclaw.service`                  |
| Модуль 8     | Docker                 | PostgreSQL-контейнер                          |
| Модуль 9     | CI/CD                  | Автодеплой при push у гілку `main`            |
| Модуль 10    | Monitoring             | `journalctl`, healthcheck endpoint            |
